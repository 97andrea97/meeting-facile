<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Calendario - Meeting Facile</title>
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet" />
  <style>
    body {
      display: flex;
      margin: 0;
      font-family: sans-serif;
    }
    #calendar {
      flex: 3;
      padding: 20px;
    }
    #sidebar {
      flex: 1;
      padding: 20px;
      background-color: #f9f9f9;
      border-left: 2px solid #ccc;
      max-width: 350px;
    }
    .slot {
      background-color: #cce5ff;
      margin-bottom: 8px;
      padding: 6px;
      border-radius: 5px;
      font-size: 14px;
    }
    .common-slot {
      background-color: #b9fbc0;
      font-weight: bold;
    }
    .other-user-slot {
      background-color: #fce5cd;
    }
    #saveBtn {
      background: black;
      color: white;
      font-size: 16px;
      padding: 12px;
      width: 100%;
      border: none;
      margin-top: 20px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="calendar"></div>
  <div id="sidebar">
    <h2>Riepilogo</h2>
    <div id="common-availability">
      <h3>Disponibilit√† comune</h3>
      <div id="common-summary"></div>
    </div>
    <hr>
    <h3>Le tue disponibilit√†</h3>
    <div id="personal-summary"></div>
    <button id="saveBtn">Salva disponibilit√†</button>
    <hr style="margin-top: 30px;">
    <button id="changeBtn" style="background-color: gray; margin-top: 10px;">
      üîÅ Cambia nome o meeting
    </button>      
</div>

  <!-- Firebase & FullCalendar -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCMQojwmEfchDlP1Bv0PpIXRTK0V7NZZU",
      authDomain: "meeting-felice.firebaseapp.com",
      databaseURL: "https://meeting-felice-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "meeting-felice",
      storageBucket: "meeting-felice.appspot.com"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const meetingName = localStorage.getItem("meetingName");
    const username = localStorage.getItem("username");

    if (!meetingName || !username) {
      alert("Dati mancanti. Torna alla home.");
      window.location.href = "index.html";
    }

    const userRef = db.ref(`availability/${meetingName}/${username}`);
    const meetingRef = db.ref(`availability/${meetingName}`);
    const settingsRef = db.ref(`settings/${meetingName}`);

    let calendar;

    function createCalendar(settings) {
      const calendarEl = document.getElementById("calendar");
      calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: "timeGridWeek",
        slotMinTime: settings.startHour + ":00",
        slotMaxTime: settings.endHour + ":00",
        allDaySlot: false,
        editable: true,
        selectable: true,
        height: "auto",
        locale: "it",
        validRange: {
          start: new Date(),
          end: new Date(Date.now() + 6 * 24 * 60 * 60 * 1000)
        },
        select: function (info) {
            const isMySlot = true;
            if (!isMySlot) return;

            calendar.addEvent({
                id: Math.random().toString(36).substring(2),
                title: username,
                start: info.startStr,
                end: info.endStr,
                backgroundColor: "#007bff",
                editable: true
            });

            saveAvailability();
        },
        eventChange: saveAvailability,
        eventRemove: saveAvailability
      });

      calendar.render();
    }

    function saveAvailability() {
      const events = calendar.getEvents()
        .filter(ev => ev.title === username)
        .map(ev => ({ start: ev.start.toISOString(), end: ev.end.toISOString() }));

      userRef.set(events);
      updateSummaries();
    }

    function updateSummaries() {
      meetingRef.once("value", snapshot => {
        const allData = snapshot.val();
        const mergedByUser = {};

        for (let user in allData) {
          mergedByUser[user] = mergeSlots(allData[user]);
        }

        // Calcola disponibilit√† comune tra tutti gli utenti
        const allMerged = Object.values(mergedByUser);
        const common = findCommonSlots(allMerged);

        // Mostra riepilogo
        showSummary("common-summary", common, "common-slot");
        showSummary("personal-summary", mergedByUser[username] || [], "slot");

        // Visualizza eventi calendario per altri utenti
        calendar.getEvents().forEach(ev => {
          if (ev.title !== username) ev.remove();
        });

        for (let user in mergedByUser) {
          if (user === username) continue;
          mergedByUser[user].forEach(slot => {
            calendar.addEvent({
              title: user,
              start: slot.start,
              end: slot.end,
              display: 'background',
              backgroundColor: '#fce5cd'
            });
          });
        }
      });
    }

    function mergeSlots(slots) {
      if (!slots || slots.length === 0) return [];
      const sorted = [...slots].sort((a, b) => new Date(a.start) - new Date(b.start));
      const merged = [sorted[0]];
      for (let i = 1; i < sorted.length; i++) {
        const last = merged[merged.length - 1];
        const current = sorted[i];
        if (new Date(current.start) <= new Date(last.end)) {
          last.end = new Date(Math.max(new Date(last.end), new Date(current.end))).toISOString();
        } else {
          merged.push(current);
        }
      }
      return merged;
    }

    function findCommonSlots(usersSlots) {
      if (usersSlots.length === 0) return [];
      let common = usersSlots[0];
      for (let i = 1; i < usersSlots.length; i++) {
        common = intersectTwo(common, usersSlots[i]);
        if (common.length === 0) break;
      }
      return common;
    }

    function intersectTwo(a, b) {
      const result = [];
      for (const s1 of a) {
        for (const s2 of b) {
          const start = new Date(Math.max(new Date(s1.start), new Date(s2.start)));
          const end = new Date(Math.min(new Date(s1.end), new Date(s2.end)));
          if (start < end) {
            result.push({ start: start.toISOString(), end: end.toISOString() });
          }
        }
      }
      return result;
    }

    function showSummary(containerId, slots, className) {
      const container = document.getElementById(containerId);
      container.innerHTML = "";
      const formatterDay = new Intl.DateTimeFormat("it-IT", { weekday: "short", day: "numeric", month: "short" });
      const formatterTime = new Intl.DateTimeFormat("it-IT", { hour: "2-digit", minute: "2-digit" });

      slots.forEach(slot => {
        const div = document.createElement("div");
        div.className = className;
        const start = new Date(slot.start);
        const end = new Date(slot.end);
        const sameDay = start.toDateString() === end.toDateString();
        const text = sameDay
          ? `${formatterDay.format(start)}, ${formatterTime.format(start)} ‚Üí ${formatterTime.format(end)}`
          : `${formatterDay.format(start)}, ${formatterTime.format(start)} ‚Üí ${formatterDay.format(end)}, ${formatterTime.format(end)}`;
        div.textContent = text;
        container.appendChild(div);
      });
    }

    // Carica impostazioni, poi crea calendario e aggiorna riepilogo
    settingsRef.once("value", snap => {
      const settings = snap.val();
      if (!settings) {
        alert("Impostazioni mancanti per questo meeting.");
        window.location.href = "setup_meeting.html";
      } else {
        createCalendar(settings);
        // Carica le disponibilit√† salvate di tutti gli utenti e disegna gli eventi
        meetingRef.once("value", snapshot => {
          const allData = snapshot.val();
          if (!allData) return;
    
          for (let user in allData) {
            const slots = allData[user];
            const isCurrentUser = (user === username);
    
            slots.forEach(slot => {
              calendar.addEvent({
                title: user,
                start: slot.start,
                end: slot.end,
                editable: isCurrentUser,
                backgroundColor: isCurrentUser ? '#007bff' : '#fce5cd',
                display: isCurrentUser ? 'auto' : 'background'
              });
            });
          }
    
          updateSummaries();
        });
      }
    });
    document.getElementById("changeBtn").addEventListener("click", () => {
    localStorage.removeItem("meetingName");
    localStorage.removeItem("username");
    window.location.href = "index.html";
    });

  </script>
</body>
</html>
